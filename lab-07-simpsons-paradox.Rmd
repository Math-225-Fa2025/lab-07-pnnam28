---
title: "Lab 07 - Smokers in Whickham"
author: "Nam Pham"
subtitle: "Simpson's paradox"
output: 
  tufte::tufte_html:
    css: ../lab.css
    tufte_variant: "envisioned"
    highlight: pygments
  tufte::tufte_handout:
    latex_engine: xelatex
    highlight: pygments
    keep_tex: true
    citation_package: natbib
link-citations: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = FALSE)
```

```{r fig.margin = TRUE, eval = TRUE, echo = FALSE}
knitr::include_graphics("img/whickham.png")
```

A study of conducted in Whickham, England recorded participants' age, smoking status at baseline, and then 20 years later recorded their health outcome.
In this lab we analyse the relationships between these variables, first two at a time, and then controlling for the third.

# Learning goals

-   Visualising relationships between variables
-   Discovering Simpson's paradox via visualisations

# Getting started

Go to the course GitHub organization and locate your homework repo, clone it in RStudio and open the R Markdown document.
Knit the document to make sure it compiles without errors.

## Warm up

Before we introduce the data, let's warm up with some simple exercises.
Update the YAML of your R Markdown file with your information, knit, commit, and push your changes.
Make sure to commit with a meaningful commit message.
Then, go to your repo on GitHub and confirm that your changes are visible in your Rmd **and** md files.
If anything is missing, commit and push again.

## Packages

We'll use the **tidyverse** package for much of the data wrangling and visualisation and the data lives in the **mosaicData** package.
These packages are already installed for you.
You can load them by running the following in your Console:

```{r eval = TRUE, message = FALSE}
library(tidyverse) 
library(mosaicData) 
```

## Data

The dataset we'll use is called Whickham from the **mosaicData** package.
You can find out more about the dataset by inspecting their documentation, which you can access by running `?Whickham` in the Console or using the Help menu in RStudio to search for `Whickham`.

# Exercises

1.  What type of study do you think these data come from: observational or experiment?
    Why?
    
  ANSWER: These data come from an observation study, not an experiment. The researchers did not randomly assign people to smoke or not; they simply recorded each participantâ€™s age, smoking status at baseline, and whether they were alive or dead 20 years later. Because there was no random assignment or intervention, this is observational rather than experimental.
  
  
2.  How many observations are in this dataset?
    What does each observation represent?
```{r n-obs, echo=TRUE,eval=TRUE}
nrow(Whickham)
``` 

  ANSWER: Each observation in this dataset represents a single individual from Whickham who was included in the study, with their age, smoking status at baseline, and whether they were alive or dead 20 years later.
  
3.  How many variables are in this dataset?
    What type of variable is each?
    Display each variable using an appropriate visualization.
    
```{r vars-and-plots, eval = TRUE}
glimpse(Whickham)
```
  ANSWER:  There are 3 varibles in this dataset: Outcome, smoker and age. All three variables are catagories type. Im using col for the smoker and outcome varibles because they only have either 2 values: TRUE or FALSE so it is better to represent in a column plot. For age is a range data so i will use histogram for better visualization.
  
```{r death_alive_plot, eval = TRUE}
Whickham %>%
  count(outcome) %>%
  ggplot(aes(x = outcome, y = n)) +
  geom_col() +
  labs(title = "Counts by health outcome")
```

```{r smoker_plot, eval = TRUE}
Whickham %>%
  count(smoker) %>%
  ggplot(aes(x = smoker, y = n)) +
  geom_col() +
  labs(title = "Counts by smoking status")
```

```{r age_plot, eval = TRUE}
Whickham %>%
  ggplot(aes(x = age)) +
  geom_histogram(binwidth = 5) +
  labs(title = "Age distribution")
```

4.  What would you expect the relationship between smoking status and health outcome to be?

 ANSWER: Based on science and my knowledge, smoking is always leading to a bad health life so I would say if they are a smoker then the percentage they dead will be higher than those who dont smoke. 

Knit, *commit, and push your changes to GitHub with an appropriate commit message. Make sure to commit and push all changed files so that your Git pane is cleared up afterwards.*

5.  Create a visualization depicting the relationship between smoking status and health outcome. Briefly describe the relationship, and evaluate whether this meets your expectations. Additionally, calculate the relevant conditional probabilities to help your narrative. Here is some code to get you started:

```{r health_smok_plot, eval=TRUE}
Whickham %>%
  count(smoker, outcome) %>%
  ggplot(aes(x = smoker, y = n, fill = outcome)) +
  geom_col(position = "fill") +   # proportions within smoker
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "Health outcome by smoking status",
    x = "Smoking status at baseline",
    y = "Proportion",
    fill = "Outcome"
  ) +
  theme_minimal()

Whickham %>%
  count(smoker, outcome) %>%
  group_by(smoker) %>%
  mutate(prop = n / sum(n))
```

  ANSWER: The bar plot shows the proportion of people who were alive or dead in each smoking group. Surprisingly, the overall proportion of people who died appears *lower* among smokers than among non-smokers. The conditional probabilities confirm this: the estimated probability of death among smokers is lower than among non-smokers, which goes against the expectation that smoking should be associated with higher mortality. This suggests that something else, such as age, might be confounding the relationship.

6.  Create a new variable called `age_cat` using the following scheme:

-   `age <= 44 ~ "18-44"`
-   `age > 44 & age <= 64 ~ "45-64"`
-   `age > 64 ~ "65+"`

```{r age-cat, eval= TRUE}
Whickham <- Whickham %>%
  mutate(
    age_cat = case_when(
      age <= 44 ~ "18-44",
      age > 44 & age <= 64 ~ "45-64",
      age > 64 ~ "65+"
    )
  )

Whickham %>%
  count(age_cat)
```

7.  Re-create the visualization depicting the relationship between smoking status and health outcome, faceted by `age_cat`. What changed? What might explain this change? Extend the contingency table from earlier by breaking it down by age category and use it to help your narrative.


```{r facet-age, eval=TRUE}
Whickham %>%
  count(smoker, age_cat, outcome) %>%
  group_by(age_cat, smoker) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = smoker, y = prop, fill = outcome)) +
  geom_col(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "Health outcome by smoking status and age category",
    x = "Smoking status at baseline",
    y = "Proportion",
    fill = "Outcome"
  ) +
  facet_wrap(~ age_cat) +
  theme_minimal()

# contingency table by age category
Whickham %>%
  count(smoker, age_cat, outcome)
```

Knit, *commit, and push your changes to GitHub with an appropriate commit message. Make sure to commit and push all changed files so that your Git pane is cleared up afterwards and review the md document on GitHub to make sure you're happy with the final state of your work.*

Now go back through your write up to make sure you've answered all questions and all of your R chunks are properly labeled. Once you decide that you are done with the homework, choose the knit drop down and select `Knit to tufte_handout` to generate a pdf. Download and submit that pdf to Canvas. 
